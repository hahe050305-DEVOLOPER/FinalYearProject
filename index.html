<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AuraCheck | Diamond Audit</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js" crossorigin="anonymous"></script>
    <style>
        :root {
            --bg-neutral: #f4f7f6; --bg-thinking: #fdf6e3; --bg-frustrated: #fbe4e4;
            --bg-sad: #e6f0fa; --bg-surprised: #fff2e6; --bg-delighted: #e6faf4;
        }
        body { 
            margin: 0; font-family: -apple-system, system-ui, sans-serif; 
            transition: background 0.7s cubic-bezier(0.22, 1, 0.36, 1); 
            overflow: hidden; background: var(--bg-neutral); color: #2c3e50; 
        }
        #app { 
            display: flex; flex-direction: column; align-items: center; padding: 25px; 
            height: 100vh; justify-content: space-between; box-sizing: border-box;
            opacity: 0; animation: quickFade 0.8s forwards;
        }
        @keyframes quickFade { from { opacity: 0; } to { opacity: 1; } }

        .view-box { 
            position: relative; width: 280px; height: 280px; border-radius: 85px; 
            overflow: hidden; border: 12px solid #fff; 
            box-shadow: 0 25px 50px rgba(0,0,0,0.05); background: #000;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        #emotion-label { 
            position: absolute; top: 20px; width: 120px; left: 80px; padding: 10px; 
            border-radius: 20px; background: rgba(255,255,255,0.92); 
            font-weight: 800; font-size: 0.7rem; letter-spacing: 2px; 
            text-align: center; z-index: 10; backdrop-filter: blur(10px);
        }
        
        .content-area { max-width: 400px; text-align: center; margin-bottom: 20px; }
        #advice { 
            font-size: 1.1rem; font-weight: 600; line-height: 1.4; min-height: 60px; 
            margin-bottom: 10px; padding: 0 30px; transition: opacity 0.3s;
        }
        .status-bar { font-size: 0.6rem; font-weight: 900; letter-spacing: 3px; color: #bdc3c7; text-transform: uppercase; }
        
        #btn-capture { 
            width: 240px; padding: 20px; border-radius: 50px; border: none; 
            background: #2c3e50; color: white; font-weight: 700; cursor: pointer;
            box-shadow: 0 10px 25px rgba(44, 62, 80, 0.2);
        }
        .loading-overlay { position: fixed; inset: 0; background: #fff; display: flex; align-items: center; justify-content: center; z-index: 100; }
    </style>
</head>
<body>
    <div id="loading" class="loading-overlay">
        <p style="font-weight: 800; letter-spacing: 4px; color: #2c3e50;">INITIALIZING</p>
    </div>

    <div id="app">
        <div class="view-box">
            <div id="emotion-label">RESTING</div>
            <video id="webcam" autoplay playsinline muted></video>
        </div>

        <div class="content-area">
            <div id="advice">Awaiting biometric alignment...</div>
            <div class="status-bar">Diamond Precision V11.1</div>
        </div>

        <button id="btn-capture">GENERATE AURA REPORT</button>
        <canvas id="output_canvas" style="display:none"></canvas>
    </div>

<script type="module">
    import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

    const themes = {
        "Neutral": { color: "#f4f7f6", label: "Balanced", insight: "System equilibrium achieved. Your aura is in a clear, resting state." },
        "Thinking": { color: "#fdf6e3", label: "Processing", insight: "Cognitive expansion detected. You are synthesizing internal data." },
        "Frustrated": { color: "#fbe4e4", label: "Tension", insight: "Micro-stress observed. Allow your breath to soften the focus." },
        "Sad": { color: "#e6f0fa", label: "Reflective", insight: "Aura softening. You are in a state of quiet introspection." },
        "Surprised": { color: "#fff2e6", label: "Reactive", insight: "System alert. Your aura has expanded in response to new stimuli." },
        "Delighted": { color: "#e6faf4", label: "Radiant", insight: "High-frequency resonance. Your organic joy is harmonizing the field." }
    };

    let faceLandmarker, video = document.getElementById("webcam");
    let currentEmotion = "Neutral", frameCount = 0, baseline = {};
    
    // SMOOTHING ENGINE
    let emotionHistory = [];
    const HISTORY_LIMIT = 5; // The "Golden Number" for speed vs stability

    async function setup() {
        const filesetResolver = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
        faceLandmarker = await FaceLandmarker.createFromOptions(filesetResolver, {
            baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task", delegate: "GPU" },
            outputFaceBlendshapes: true, runningMode: "VIDEO", numFaces: 1
        });
        document.getElementById("loading").style.display = "none";
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        video.srcObject = stream;
        video.addEventListener("loadeddata", predictWebcam);
    }

    function getDominant(arr) {
        return arr.sort((a,b) => arr.filter(v => v===a).length - arr.filter(v => v===b).length).pop();
    }

    async function predictWebcam() {
        const result = faceLandmarker.detectForVideo(video, performance.now());
        if (result.faceBlendshapes?.length > 0) {
            const shapes = {};
            result.faceBlendshapes[0].categories.forEach(c => shapes[c.categoryName] = c.score);
            const landmarks = result.faceLandmarks[0];

            if (frameCount < 20) { // Ultra-fast calibration
                for (let key in shapes) baseline[key] = (baseline[key] || 0) + (shapes[key] / 20);
                frameCount++;
            } else {
                let instantDetect = "Neutral";
                const headTilt = Math.abs(landmarks[4].x - (landmarks[234].x + landmarks[454].x) / 2) + 
                                 Math.abs(landmarks[4].y - (landmarks[10].y + landmarks[152].y) / 2);

                if (headTilt > 0.18) { instantDetect = "Thinking"; }
                else {
                    if (shapes.mouthSmileLeft > 0.35 || (shapes.eyeSquintLeft > 0.35 && shapes.mouthSmileLeft > 0.15)) instantDetect = "Delighted";
                    else if (shapes.eyeWideLeft > 0.18 || shapes.jawOpen > 0.3) instantDetect = "Surprised";
                    else if (shapes.browDownLeft > 0.32 || shapes.browDownRight > 0.32) instantDetect = "Frustrated";
                    else if ((shapes.browInnerUp - (baseline.browInnerUp || 0)) > 0.12 || shapes.mouthFrownLeft > 0.25) instantDetect = "Sad";
                }
                
                // Add to history and get the most frequent emotion (Stability Logic)
                emotionHistory.push(instantDetect);
                if (emotionHistory.length > HISTORY_LIMIT) emotionHistory.shift();
                
                const stabilized = getDominant([...emotionHistory]);
                if (stabilized !== currentEmotion) {
                    currentEmotion = stabilized;
                    updateUI(currentEmotion);
                }
            }
        }
        window.requestAnimationFrame(predictWebcam);
    }

    function updateUI(label) {
        const data = themes[label];
        document.body.style.background = data.color;
        document.getElementById("emotion-label").innerText = data.label.toUpperCase();
        document.getElementById("advice").innerText = data.insight;
    }

    document.getElementById("btn-capture").onclick = () => {
        const canvas = document.getElementById("output_canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = 600; canvas.height = 700;
        ctx.save(); ctx.scale(-1, 1); ctx.drawImage(video, -600, 0, 600, 500); ctx.restore();
        const data = themes[currentEmotion];
        ctx.fillStyle = data.color; ctx.fillRect(0, 500, 600, 200);
        ctx.fillStyle = "#2c3e50"; ctx.font = "bold 34px sans-serif";
        ctx.fillText(data.label + " Aura State", 45, 565);
        ctx.font = "22px sans-serif"; ctx.fillStyle = "#7f8c8d";
        ctx.fillText(data.insight, 45, 615);
        const link = document.createElement('a');
        link.download = `AuraAudit_V11.png`; link.href = canvas.toDataURL(); link.click();
    };

    setup();
</script>
</body>
</html>
